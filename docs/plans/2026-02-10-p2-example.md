# Example App (prowadzacy port) Implementation Plan

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Uruchamialny example/ demonstrujący P1 framework — port ~10% prowadzacy z F3.

**Architecture:** Standardowa struktura: public/index.php (bootstrap + routes), app/P1.php (project facade), controllers/, templates/. SQLite DB dla sesji. Layout z nav + flash + content. 5 routes demonstrujących pełny lifecycle: static page, auth (login/logout), admin guard, CSRF, flash messages.

**Tech Stack:** PHP 8.4+, P1 framework (src/P1.php z parent repo), SQLite, php built-in server.

---

### Task 1: Struktura katalogów i config

**Files:**
- Create: `example/public/index.php`
- Create: `example/config/app.php`
- Create: `example/public/.htaccess`

**Step 1: Utwórz katalogi**

```bash
mkdir -p example/{public,config,app,controllers,templates,data}
```

**Step 2: Napisz config**

`example/config/app.php`:
```php
<?php
declare(strict_types=1);

return [
    'debug' => 3,
    'timezone' => 'Europe/Warsaw',
    'db' => [
        'dsn' => 'sqlite:' . dirname(__DIR__) . '/data/app.db',
    ],
    'view_path' => dirname(__DIR__) . '/templates',
    'log_path' => dirname(__DIR__) . '/data/logs',

    // Hardcoded demo credentials
    'admin_user' => 'admin',
    'admin_pass' => '$2y$10$YourHashHere', // password_hash('admin123', PASSWORD_DEFAULT)
];
```

**Step 3: Napisz bootstrap index.php**

`example/public/index.php`:
```php
<?php
declare(strict_types=1);

// Load framework
require dirname(__DIR__, 2) . '/vendor/autoload.php';

// Load project classes
require dirname(__DIR__) . '/app/P1.php';
require dirname(__DIR__) . '/controllers/BaseController.php';
require dirname(__DIR__) . '/controllers/PageController.php';
require dirname(__DIR__) . '/controllers/AuthController.php';
require dirname(__DIR__) . '/controllers/AdminController.php';

// Bootstrap
$app = new \P1\App();
$app->loadConfig(dirname(__DIR__) . '/config/app.php');

// Database
$db = $app->db();

// Create sessions table if not exists (SQLite)
$db->exec('CREATE TABLE IF NOT EXISTS sessions (
    session_id VARCHAR(128) NOT NULL PRIMARY KEY,
    data TEXT NOT NULL DEFAULT "",
    ip VARCHAR(45) NOT NULL DEFAULT "",
    agent VARCHAR(5000) NOT NULL DEFAULT "",
    stamp INT NOT NULL DEFAULT 0
)');

// DB session handler
$session = new \P1\Session($db, advisory: false);
$session->register();
session_start();

// Init logging
\P1\Log::init((string) $app->config('log_path'), 3);

// Routes
$app->get('/', PageController::class, 'home', name: 'home');
$app->get('/kontakt', PageController::class, 'kontakt', name: 'kontakt');
$app->get('/login', AuthController::class, 'loginForm', name: 'login');
$app->post('/login', AuthController::class, 'login');
$app->get('/logout', AuthController::class, 'logout', name: 'logout');
$app->get('/admin', AdminController::class, 'dashboard', name: 'admin');

// Run
$app->run();
```

**Step 4: Dodaj .htaccess i .gitignore**

`example/public/.htaccess`:
```
RewriteEngine On
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]
```

Dodaj do głównego `.gitignore`:
```
example/data/
```

**Step 5: Uruchom i sprawdź czy się ładuje**

```bash
cd example/public && php -S localhost:8080
# Oczekiwany wynik: serwer startuje bez błędów PHP
# Ctrl+C
```

**Step 6: Commit**

```bash
git add example/public/index.php example/config/app.php example/public/.htaccess .gitignore
git commit -m "example: bootstrap with config, routes, SQLite sessions"
```

---

### Task 2: Klasa P1 (project facade) i BaseController

**Files:**
- Create: `example/app/P1.php`
- Create: `example/controllers/BaseController.php`

**Step 1: Napisz P1 facade**

`example/app/P1.php`:
```php
<?php
declare(strict_types=1);

class P1 extends \P1\Base {
    // Demo role constants
    const ROLE_ADMIN = 'admin';
    const ROLE_USER = 'user';

    public static function isLoggedIn(): bool {
        return self::currentUser() !== null;
    }

    public static function isAdmin(): bool {
        return (self::currentUser()['role'] ?? '') === self::ROLE_ADMIN;
    }

    public static function currentUser(): ?array {
        return $_SESSION['user'] ?? null;
    }
}
```

**Step 2: Napisz BaseController z layout rendering**

`example/controllers/BaseController.php`:
```php
<?php
declare(strict_types=1);

class BaseController extends \P1\Controller {
    protected function render(string $template, array $data = []): \P1\Response {
        $data['is_logged_in'] = P1::isLoggedIn();
        $data['is_admin'] = P1::isAdmin();
        $data['current_user'] = P1::currentUser();

        return parent::render($template, $data);
    }
}
```

**Step 3: Commit**

```bash
git add example/app/P1.php example/controllers/BaseController.php
git commit -m "example: P1 facade and BaseController with auth helpers"
```

---

### Task 3: Layout i templates

**Files:**
- Create: `example/templates/layout.php`
- Create: `example/templates/_flash.php`
- Create: `example/templates/home.php`
- Create: `example/templates/kontakt.php`

**Step 1: Napisz layout**

`example/templates/layout.php`:
```php
<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="utf-8">
    <title><?= h($title ?? 'P1 Example') ?></title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: system-ui, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; color: #333; }
        nav { border-bottom: 2px solid #eee; padding: 10px 0; margin-bottom: 20px; }
        nav a { margin-right: 15px; text-decoration: none; color: #0066cc; }
        nav a:hover { text-decoration: underline; }
        nav .right { float: right; }
        .flash { padding: 10px 15px; margin-bottom: 15px; border-radius: 4px; }
        .flash-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flash-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .flash-warning { background: #fff3cd; color: #856404; border: 1px solid #ffeeba; }
        .flash-info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        form label { display: block; margin: 10px 0 5px; font-weight: 600; }
        form input[type=text], form input[type=password] { padding: 8px; width: 250px; border: 1px solid #ccc; border-radius: 4px; }
        form button { padding: 8px 20px; background: #0066cc; color: white; border: none; border-radius: 4px; cursor: pointer; margin-top: 10px; }
        form button:hover { background: #0052a3; }
        footer { margin-top: 40px; padding-top: 20px; border-top: 1px solid #eee; color: #999; font-size: 0.9em; }
        .admin-link { color: #cc0000 !important; }
    </style>
</head>
<body>
    <nav>
        <a href="/">Home</a>
        <a href="/kontakt">Kontakt</a>
        <?php if ($is_admin ?? false): ?>
            <a href="/admin" class="admin-link">Admin</a>
        <?php endif; ?>
        <span class="right">
            <?php if ($is_logged_in ?? false): ?>
                <?= h($current_user['name'] ?? 'User') ?>
                | <a href="/logout">Wyloguj</a>
            <?php else: ?>
                <a href="/login">Zaloguj</a>
            <?php endif; ?>
        </span>
    </nav>

    <?= $view->partial('_flash.php', ['flash' => $flash ?? []]) ?>

    <?= $content ?>

    <footer>
        <p>P1 Framework Example &copy; <?= date('Y') ?></p>
    </footer>
</body>
</html>
```

**Step 2: Napisz flash partial**

`example/templates/_flash.php`:
```php
<?php foreach ($flash as $msg): ?>
    <div class="flash flash-<?= h($msg['type']) ?>"><?= h($msg['text']) ?></div>
<?php endforeach; ?>
```

**Step 3: Napisz home i kontakt templates**

`example/templates/home.php`:
```php
<?php $view->layout('layout.php', ['title' => 'P1 Example']); ?>

<h1>P1 Framework</h1>
<p>Demo aplikacji na frameworku P1. Port fragmentu projektu ProwadzacyStrzelanie.eu.</p>

<h3>Co demonstruje ten example:</h3>
<ul>
    <li><a href="/kontakt">Kontakt</a> &mdash; statyczna strona z layoutem</li>
    <li><a href="/login">Login</a> &mdash; formularz z CSRF, flash messages, redirect</li>
    <li><a href="/admin">Admin</a> &mdash; strona z auth guardem (beforeRoute)</li>
</ul>
```

`example/templates/kontakt.php`:
```php
<?php $view->layout('layout.php', ['title' => 'Kontakt']); ?>

<h2>Kontakt</h2>
<p>Przykładowa strona kontaktowa. W prowadzacy.eu jest tutaj informacja o kursie.</p>
<p>Mail: <strong>example@example.com</strong></p>

<h4>O projekcie</h4>
<p>P1 to jednoplikowy micro-framework PHP 8.4+ inspirowany wzorcami z Fat-Free Framework.
   Zero zależności, deployment przez copy-paste.</p>
```

**Step 4: Commit**

```bash
git add example/templates/
git commit -m "example: layout, flash partial, home and kontakt templates"
```

---

### Task 4: PageController

**Files:**
- Create: `example/controllers/PageController.php`

**Step 1: Napisz PageController**

`example/controllers/PageController.php`:
```php
<?php
declare(strict_types=1);

class PageController extends BaseController {
    public function home(): \P1\Response {
        return $this->render('home.php');
    }

    public function kontakt(): \P1\Response {
        return $this->render('kontakt.php');
    }
}
```

**Step 2: Sprawdź czy działa**

```bash
cd example/public && php -S localhost:8080 &
curl -s http://localhost:8080/ | head -5
curl -s http://localhost:8080/kontakt | head -5
# Oczekiwany: HTML z layoutem
kill %1
```

**Step 3: Commit**

```bash
git add example/controllers/PageController.php
git commit -m "example: PageController with home and kontakt pages"
```

---

### Task 5: AuthController (login/logout + CSRF + flash)

**Files:**
- Create: `example/controllers/AuthController.php`
- Create: `example/templates/login.php`

**Step 1: Napisz login template**

`example/templates/login.php`:
```php
<?php $view->layout('layout.php', ['title' => 'Logowanie']); ?>

<h2>Logowanie</h2>
<p>Demo: login <code>admin</code>, hasło <code>admin123</code></p>

<form method="post" action="/login">
    <?= $csrf_input ?>
    <label for="username">Login</label>
    <input type="text" id="username" name="username" required>

    <label for="password">Hasło</label>
    <input type="password" id="password" name="password" required>

    <button type="submit">Zaloguj</button>
</form>
```

**Step 2: Napisz AuthController**

`example/controllers/AuthController.php`:
```php
<?php
declare(strict_types=1);

class AuthController extends BaseController {
    public function loginForm(): \P1\Response {
        if (P1::isLoggedIn()) {
            return $this->redirect('/');
        }
        return $this->render('login.php');
    }

    public function login(): \P1\Response {
        $this->validateCsrf();

        $data = $this->postData(['username', 'password']);
        $username = trimS($data['username']);
        $password = (string) ($data['password'] ?? '');

        $expectedUser = (string) P1::config('admin_user');
        $expectedPass = (string) P1::config('admin_pass');

        if ($username !== $expectedUser || !password_verify($password, $expectedPass)) {
            $this->flash('error', 'Nieprawidłowy login lub hasło.');
            \P1\Log::info('Login failed', ['user' => $username, 'ip' => $this->request->ip]);
            return $this->redirect('/login');
        }

        $_SESSION['user'] = [
            'id' => 1,
            'name' => $username,
            'role' => P1::ROLE_ADMIN,
        ];

        $this->flash('success', 'Zalogowano!');
        \P1\Log::info('Login OK', ['user' => $username]);
        return $this->redirect('/admin');
    }

    public function logout(): \P1\Response {
        $_SESSION = [];
        session_destroy();
        return $this->flashAndRedirect('info', 'Wylogowano.', '/');
    }
}
```

**Step 3: Wygeneruj hash hasła i wstaw do config**

```bash
php -r "echo password_hash('admin123', PASSWORD_DEFAULT);"
# Skopiuj wynik do example/config/app.php w polu admin_pass
```

**Step 4: Sprawdź flow**

```bash
cd example/public && php -S localhost:8080 &
# GET /login → formularz
curl -s http://localhost:8080/login | grep -c 'csrf_token'
# Oczekiwany: 1 (jest hidden input z tokenem)
kill %1
```

**Step 5: Commit**

```bash
git add example/controllers/AuthController.php example/templates/login.php example/config/app.php
git commit -m "example: AuthController with login/logout, CSRF, flash messages"
```

---

### Task 6: AdminController z beforeRoute guard

**Files:**
- Create: `example/controllers/AdminController.php`
- Create: `example/templates/admin/dashboard.php`

**Step 1: Napisz admin dashboard template**

```bash
mkdir -p example/templates/admin
```

`example/templates/admin/dashboard.php`:
```php
<?php $view->layout('layout.php', ['title' => 'Admin Dashboard']); ?>

<h2>Admin Dashboard</h2>
<p>Zalogowano jako: <strong><?= h($current_user['name'] ?? '') ?></strong>
   (rola: <?= h($current_user['role'] ?? '') ?>)</p>

<h4>Demo info</h4>
<ul>
    <li>Session handler: P1\Session (SQLite)</li>
    <li>CSRF: token w sesji, walidacja w Controller::validateCsrf()</li>
    <li>Flash: session-based, auto-cleared po wyświetleniu</li>
    <li>Auth guard: AdminController::beforeRoute() → redirect jeśli nie admin</li>
</ul>

<p><a href="/logout">Wyloguj</a></p>
```

**Step 2: Napisz AdminController**

`example/controllers/AdminController.php`:
```php
<?php
declare(strict_types=1);

class AdminController extends BaseController {
    public function beforeRoute(): \P1\Response|null {
        if (!P1::isLoggedIn()) {
            $this->flash('warning', 'Musisz się zalogować.');
            return $this->redirect('/login');
        }
        if (!P1::isAdmin()) {
            $this->flash('error', 'Brak dostępu.');
            return $this->redirect('/');
        }
        return null;
    }

    public function dashboard(): \P1\Response {
        return $this->render('admin/dashboard.php');
    }
}
```

**Step 3: End-to-end test w przeglądarce**

```bash
cd example/public && php -S localhost:8080
```

Scenariusze do sprawdzenia:
1. `GET /` → strona główna z linkami
2. `GET /kontakt` → strona kontaktu
3. `GET /admin` → redirect do /login z flash "Musisz się zalogować"
4. `GET /login` → formularz
5. POST /login z admin/admin123 → redirect do /admin z flash "Zalogowano!"
6. `GET /admin` → dashboard (bo zalogowany)
7. `GET /logout` → redirect do / z flash "Wylogowano"
8. `GET /admin` → znów redirect do /login

**Step 4: Commit**

```bash
git add example/controllers/AdminController.php example/templates/admin/
git commit -m "example: AdminController with auth guard and dashboard"
```

---

### Task 7: Final polish

**Files:**
- Modify: `example/config/app.php` (final hash)
- Create: `example/README.md`

**Step 1: Napisz README**

`example/README.md`:
```markdown
# P1 Framework Example

Port ~10% projektu [ProwadzacyStrzelanie.eu](https://prowadzacystrzelanie.eu) z Fat-Free Framework na P1.

## Uruchomienie

```bash
cd example/public
php -S localhost:8080
```

Otwórz http://localhost:8080

## Demo login

- Login: `admin`
- Hasło: `admin123`

## Co demonstruje

| Feature | Route | Plik |
|---------|-------|------|
| Static page + layout | GET /kontakt | PageController::kontakt |
| Login form + CSRF | GET/POST /login | AuthController::loginForm/login |
| Flash messages | redirect po login/logout | Flash + _flash.php partial |
| Auth guard (beforeRoute) | GET /admin | AdminController::beforeRoute |
| DB sessions (SQLite) | automatyczne | P1\Session + data/app.db |
| Project facade | P1::isLoggedIn() etc | app/P1.php extends \P1\Base |

## Struktura

```
example/
├── public/index.php        # bootstrap, routes, server entry
├── config/app.php          # config (returns array)
├── app/P1.php              # class P1 extends \P1\Base
├── controllers/
│   ├── BaseController.php  # layout rendering, auth data
│   ├── PageController.php  # home, kontakt
│   ├── AuthController.php  # login, logout
│   └── AdminController.php # beforeRoute guard, dashboard
├── templates/
│   ├── layout.php          # HTML wrapper
│   ├── _flash.php          # flash messages partial
│   ├── home.php
│   ├── kontakt.php
│   ├── login.php
│   └── admin/dashboard.php
└── data/                   # SQLite DB (gitignored)
```
```

**Step 2: Commit all**

```bash
git add example/README.md
git commit -m "example: README with usage instructions"
```
